
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tech Notes</title>
  <meta name="author" content="OGIBAYASHI Hironori">

  
  <meta name="description" content="Hadoop Summit Tokyo に行ってきたので雑に感想を. 全体的な印象としては、Cloud, 機械学習, Spark, Zeppelinあたりの話題が目立ったなぁ、と思った. 所謂集計バッチ的なものは既にどこもやってて、その基盤の上でデータサイエンティストがSpark &amp; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ogibayashi.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tech Notes" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tech Notes</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ogibayashi.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/27/hadoop-summit-tokyo-2016/">Hadoop Summit 2016 Tokyo に行ったメモ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-27T21:15:07+09:00" pubdate data-updated="true">Oct 27<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/10/27/hadoop-summit-tokyo-2016/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/10/27/hadoop-summit-tokyo-2016/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://hadoopsummit.org/tokyo/">Hadoop Summit Tokyo</a> に行ってきたので雑に感想を.</p>

<p>全体的な印象としては、Cloud, 機械学習, Spark, Zeppelinあたりの話題が目立ったなぁ、と思った. 所謂集計バッチ的なものは既にどこもやってて、その基盤の上でデータサイエンティストがSpark &amp; Zeppelinで色々試した結果できあがったもの(多くは機械学習を使ったもの)を、定常的に回すようにする、というのが割りと一般的になっている感じ.</p>

<p>ちょっと前とかは、もう少しリアルタイムとかストリーム的な話題が多かったような気がするけど、そっちは少し下火になったようにも思う. まあ、実際ストリーム処理をやっていて思うのは、できると一見かっこいいけど、そこまで必要ないケースも多いし、運用負荷高いよね、ということ. バッチと比べるとより即時対応が求められるし、やり直しとかしづらいし. その割に、リアルタイム性が価値を生むようなユースケースって少ない. 今回のセッションの中であったような、不正検知、異常検知なんかは即時性が重要だけど、そのくらいなんじゃなかろうか. 大抵hourlyくらいでバッチ回せれば済んでしまう.
とは言え、社内だと30分更新とか10分更新みたいな微妙なユースケースもあったりするので、その辺何が良いんだろうなあ、とは思う.</p>

<p>SQL on Hadoopなところだと、意外にPrestoは話題に上らないなあ、と思った. 自分のところでは使っていて、とても良いと思うのだけど、その手の話題であまり出てこない.</p>

<p>印象に残ったセッションは、リクルートテクノロジーズさんの、&#8221;Struggle against crossdomain data complexity in Recruit group&#8221;というもの. すごく沢山のサービスを扱ってて、ログも多様で、時々フォーマットが変わったりして、的な苦労には共感できた. そして、ロジックを共有のjar(var/log という名前らしい)に入れて、jar+XMLで処理を記述できるようにする、jarに入れる処理の部分は、Zeppelinで本番データを相手に色々試して、良さげになったらjarに組み込むことで再利用可能にする、という仕組みは良さそうに思えた.
実行エンジンも、そのvar/log jarの中でHiveとかSparkとか、いい感じに選んでくれるっぽい. パクれそうな要素もあるような気がするので、資料が公開されたら見直してみよう.</p>

<p>その他のセッションも面白かったし、久しぶりに昔の同僚とも顔を合わせたりとかして、楽しいイベントでありました.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/21/about-my-flink-deployment/">現在稼働しているFlinkクラスタについて</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-21T22:35:50+09:00" pubdate data-updated="true">Oct 21<span>st</span>, 2016</time>
        
           | <a href="/blog/2016/10/21/about-my-flink-deployment/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/10/21/about-my-flink-deployment/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>先日の<a href="http://www.slideshare.net/linecorp/b-6-new-stream-processing-platformwith-apache-flink">発表</a>で、Apache Flinkを導入するに至った経緯を話したのだけど、具体的な構成とかには触れられなかったので書いておく。</p>

<h2>クラスタの構成について</h2>

<p>今運用してるFlinkクラスタは２つ。サービスで使うためのデータを生成しているものと、社内のレポーティングやモニタリングで使っているもの。前者の方は安定性重視、後者は割とカジュアルにジョブを追加したり、構成を弄ったりできるもの、という感じになっている.</p>

<p>Flinkとしては、クラスタのデプロイメント方式として、独立したdaemonとして動かす方法と、YARNの上で動かす方法があるのだけど、前者の方法にしている. その方が運用上もわかりやすいし、レイヤが少ない分トラブルも少ないだろう、というのが理由.</p>

<p>どちらも物理サーバで、TaskManagerサーバは前者が3台、後者が10台になっている. Flinkのバージョンはそれぞれ1.0.3と1.1.1. JobManagerはもちろんHAで、Flinkが使うHDFSやZookeeperは既存Hadoopクラスタを共用している.</p>

<h2>周辺の構成</h2>

<p>Flinkへのインプットはfluentdで集めたログをKafkaに投入したもの。もともとログはがっつりfluentdで集めてたので、Kafkaを導入して、そちらにも飛ばすようにした。ちなみに、fluentd→kafkaの部分について、導入当初はfluent-plugin-kafkaが使っていたposeidon gemがメンテナンス停止を宣言したりしてて若干不安があったけど、その後poseidonはruby-kafkaに置き換えられ、pluginもfluentdの公式になったりして、安心感が大分増した。開発者の方々には感謝してます。</p>

<p>アウトプットはRedis, Elasticsearch, Kafkaの3パターンがある. 汎用的に使いやすいのはElasticserachで、Kibanaで見たり、集計結果をAPIサーバ経由で他に提供したりしている. Redisは最新の情報にしか興味がなくて、かつ更新頻度が高い場合に使っている. 特定のキーの値を10秒間隔でアップデート、とか. Kafkaは、集計結果を他と連携したいケース. 今は、<a href="https://github.com/ogibayashi/kafka-topic-exporter">kafka-topic-exporter</a> 経由で集計結果を<a href="https://prometheus.io/">Prometheus</a>に入れ、<a href="http://grafana.org/">Grafana</a>で見るために使っている.</p>

<h2>運用周り</h2>

<p>モニタリングは基本的にPrometheus. <a href="https://github.com/matsumana/flink_exporter">flink-exporter</a>と<a href="https://github.com/prometheus/jmx_exporter">jmx-expoter</a>を使ってメトリクスをPrometheusに送り、Grafanaで見ている.</p>

<p>Flinkのメトリクスについては <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.1/apis/metrics.html">https://ci.apache.org/projects/flink/flink-docs-release-1.1/apis/metrics.html</a> に記載があるが、JMXで見るためには、flink-conf.yamlに以下の設定を追加する. なお、これが使えるのはFlink 1.1以降.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>metrics.reporters: jmx_reporter
</span><span class='line'>metrics.reporter.jmx_reporter.class: org.apache.flink.metrics.jmx.JMXReporter
</span><span class='line'>env.java.opts: -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.port=5560</span></code></pre></td></tr></table></div></figure>


<p>jmx_expoterの設定は、<a href="https://gist.github.com/ogibayashi/26c976442592b285fd0ff6b07b08ec60">こんな感じ</a> のものを使っている</p>

<p>すると、こんな感じでFlinkのKafkaConsumerのlagやconsumeされているレコード数を見ることができる.</p>

<p><img src="/images/2016/grafana_flink_kafka.png" alt="Flink_Grafana_Kafka" /></p>

<p>以下は、あるジョブのチェックポイントのサイズ. 長期のスパンで見ると、チェックポイントサイズが増加傾向なので何かしら不要なstateがpurgeされずに溜まっていることが疑われる</p>

<p><img src="/images/2016/grafana_flink_checkpoint.png" alt="Flink_Grafana_Checkpoint" /></p>

<p>監視は外部からdaemonのTCPポートが空いていることを確認している. JobManagerはWebUIポート(8081)を見れば良いが、TaskManagerのポートは起動するたびに変わるので、以下のような設定を入れて固定している.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>taskmanager.rpc.port: 6122
</span><span class='line'>taskmanager.data.port: 6121</span></code></pre></td></tr></table></div></figure>


<p>Flink的なメトリクスとしては、Exceptionの発生数とか、ジョブが失敗や再起動状態にあるジョブの数とかも使ってアラートを上げた方がいいんだろうなぁ、と思いつつまだやっていない</p>

<h2>まとめ</h2>

<p>今productionで動かしているFlinkクラスタについて、構成や運用周りを紹介してみた. これからFlinkを使ってみよう、という人の参考になれば幸いです.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/13/thoughts-on-apache-flink/">Apache Flinkを試してみての感想</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-13T19:42:13+09:00" pubdate data-updated="true">May 13<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/05/13/thoughts-on-apache-flink/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/05/13/thoughts-on-apache-flink/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>しばらくApache Flinkを試してみたので、感想を書いておこうと思う.</p>

<h2>試したこと</h2>

<ul>
<li>standalone modeでのクラスタ構築</li>
<li>ストリーミングジョブを書いてみる

<ul>
<li>TumblingTimeWindowやSlidingTimeWindowでの集計</li>
<li>Kafka SourceとElasticsearch Sinkの利用</li>
<li>必要だったので、カスタムトリガは書いた</li>
</ul>
</li>
<li>幾つかのジョブで性能測定</li>
<li>社内の本番fluentdからKafka経由でFlinkにストリームを投入し、ジョブを十数日くらい連続稼働してみる</li>
<li>state backendをHDFSやRocksDBにしてみる</li>
<li>JobManager HA</li>
<li>TaskManagerやJobManagerを落としてみる</li>
<li>Flink on YARN (ジョブを起動してみただけ)</li>
</ul>


<h2>試してないこと</h2>

<ul>
<li>DataSet APIの利用</li>
<li>savepoint, savepointからの復旧</li>
<li>event timeやingenstion timeの利用(processing timeしか使ってない)</li>
<li>複数ジョブの相乗り</li>
<li>高トラフィックかつ複数ジョブでの連続稼働</li>
<li>Flink on YARNをもうちょっと色々使ってみる</li>
<li>(多分他にも色々)</li>
</ul>


<h2>所感</h2>

<p>全体としてはすごく良く出来ていると思う. プロセスが落ちたりしても勝手に復旧するし、性能も出るし、WebUIやREST APIで色々情報取れるので運用もしやすそう. 今後は本番に入れていこうと思っている.</p>

<ul>
<li>ちゃんと動く？

<ul>
<li>期待通りに動かなくて、MLで聞いたらBugだ、って言われて直してくれたのが2件</li>
<li>ContinuousProcessingTimeTriggerは期待通りの動作をしなかったので、修正版を書く必要があった</li>
<li>後は、上記の範囲では特に問題なく動いている</li>
</ul>
</li>
<li>処理の書きやすさ

<ul>
<li>APIがハイレベルなので、割と少ないコードで処理を書くことができて良い</li>
<li>状態の保存とか、windowとか、自分で書くのは大変なのでその辺の面倒はFlinkが見てくれる</li>
</ul>
</li>
<li>性能

<ul>
<li>もちろん処理によるが、単純なものであれば1CPUで10万records/sec以上は普通に処理できそう</li>
</ul>
</li>
<li>耐障害性

<ul>
<li>ジョブ実行中にJobManagerやTaskManagerを落としてみたが、勝手に復旧された. すごい.</li>
<li>HDFS障害でどう振る舞うか？はまだ試せてないけど気になるところ</li>
</ul>
</li>
<li>運用

<ul>
<li>WebUIやREST APIで色々取れる. WebUIで大抵のものは見える印象.</li>
<li>スロット数とかはもちろん、ジョブ内のオペレータ単位で処理レコード数とか取れる</li>
<li>チェックポイントの所要時間やサイズも取れる</li>
</ul>
</li>
<li>不安なところ

<ul>
<li>チェックポイントのサイズには注意がいりそう. FsStateBackendの場合、状態は全て各TaskManagerのメモリに持ち、チェックポイントでHDFSに書き出される. 差分スナップショット的なものはないので、状態が大きくなってくるとスナップショットに時間がかかり、性能劣化する. キー(keyByで指定する奴)の数が大きいケースでは、RocksDBを使うことで改善されるらしいが、まだそれが有効なケースに出会ってない.</li>
<li>FlinkジョブをYARNで動かす場合を除いて、各TaskManagerは1プロセスで、その中で複数ジョブがスレッドとして動く形になっているのでisolationの部分は不安. あるジョブに引きづられてTaskManagerが固まるとかありそう.</li>
<li>ストリーム処理のプロダクトはいくつかあるし、Facebook, Twitter, Likedinみたいな大御所がバックにいるわけではないので、生き残っていくのだろうか</li>
</ul>
</li>
</ul>


<h2>まとめ</h2>

<p>ということで、自分がしばらく試しての所感を書いてみた.
実績の少ないプロダクトという意味での不安感はあるけど、性能、拡張性、耐障害性、APIの使いやすさは素晴らしいと思うので、使っていきたい. これ以上は使ってみないとわからないと思うし. あと、Flink on YARNの場合はYARNが動くクラスタがあれば、別途サーバを用意しなくてもFlinkジョブを動かすことができるので、既にHadoop環境がある場合なんかは、とりあえず試してみると良いんじゃないかと思う.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/08/flink-state-management/">Apache Flinkのstate管理について</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-08T12:09:26+09:00" pubdate data-updated="true">Apr 8<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/04/08/flink-state-management/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/04/08/flink-state-management/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>はじめに</h2>

<p>ストリーム処理の中で、処理をstatefulにしたい、という要求はよくある。例えば、1時間のtime windowで件数を集計している場合、ストリームが流れるにつれて内部で保持しているカウンタは増加していく.
そして、障害等で再起動をした時とかには、そのカウンタの値も一緒に復旧したい.</p>

<h2>Flinkにおけるstateの保存</h2>

<p>これに対して、Apache Flinkは定期的に処理状態のスナップショットを取得する、という方法で対応している.
そして、分散環境でまともに全てのスナップショットを取るのは辛いので、分散してスナップショットを取るようにしている. 具体的には<a href="https://ci.apache.org/projects/flink/flink-docs-master/internals/stream_checkpointing.html">ここ</a> に詳しいが、ストリームのソースから定期的にBarrierと呼ばれる印を流して、各オペレータはこれを受け取るとスナップショットを保存するようになっている. こうすることで、処理全体を止めずに一貫性のあるスナップショットを取れるよね、という話. 障害時にはスナップショットから状態を復旧し、スナップショット以降のログをリプレイすることで処理を継続する.</p>

<p>スナップショットの保存先は、以下から選択することができる. グローバルのデフォルトを設定することも、ジョブ単位でそれを上書きすることも可能.  (詳しくは<a href="https://ci.apache.org/projects/flink/flink-docs-master/apis/streaming/state_backends.html">ここ</a>)</p>

<ul>
<li>MemoryStateBacked

<ul>
<li>デフォルト. チェックポイントの際にJobManagerのメモリ上に状態を保持する. デフォルトはサイズが5MBまで.</li>
</ul>
</li>
<li>FsStateBackend

<ul>
<li>ファイルシステムに保持する. 最新の状態はTaskManagerのメモリに保持し、チェックポイントの際にファイルシステムに保存する. ファイルシステムはローカルでもHDFSでも良いが、障害時に別ノードで復旧することを考えるとHDFSになるだろう.</li>
</ul>
</li>
<li>RocksDBStateBackend

<ul>
<li>最新の状態はTaskManagerローカルファイルシステム上のRocksDBに保持し、チェックポイントの際にそれをFsStateBackendと同じようにファイルシステムに保存する. スループットは若干落ちるが、大量のstateを保持することができる.</li>
</ul>
</li>
</ul>


<h2>実験</h2>

<p>とは言え、処理によってはstateが大きくなるケースもあるわけで、そういう時にどうなるんだろう？と思って実験してみた.
環境はFlink 1.0.0でKafka, Flink, HDFSは物理サーバ.</p>

<p>こんな感じで、foobarというフィールドに100バイトのランダム文字列を入れて、それのdistinct countを取る. 重複を判断するためには、過去の値をすべて持たないといけないので状態は大きくなる.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ head -n 1 dummy_log.aa 
</span><span class='line'>id:0000 time:[2016-04-05 12:40:57]      level:DEBUG     method:POST     uri:/api/v1/people1     reqtime:3.053540515830725       foobar:dNjtvYKxgyym6bMNxUyrLznijuZqZfpVasJyXZDttoNGbj5GFk</span></code></pre></td></tr></table></div></figure>


<p>こんな感じのコードで、処理を記述した(MyContinuousProcessingTimeTriggerはデフォルトのContinuousProcessingTimeTriggerに若干の改修を入れたもの).
保存先はHDFSとしている. timeWindowAllなので、処理は分散されず単一のスレッドで処理される.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">stream</span> <span class="k">=</span> <span class="n">env</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlinkKafkaConsumer09</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;kafka.json2&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleStringSchema</span><span class="o">(),</span> <span class="n">properties</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">parseJson</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class='line'>  <span class="o">.</span><span class="n">timeWindowAll</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">DAYS</span><span class="o">))</span>
</span><span class='line'>  <span class="o">.</span><span class="n">trigger</span><span class="o">(</span><span class="nc">MyContinuousProcessingTimeTrigger</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">seconds</span><span class="o">(</span><span class="mi">5</span><span class="o">)))</span>
</span><span class='line'>  <span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="nc">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]()){(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="n">r</span> <span class="o">+</span> <span class="n">i</span><span class="o">}}</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="o">)}</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">ElasticsearchSink</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">transports</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IndexRequestBuilder</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Int</span><span class="o">]]</span>  <span class="o">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">createIndexRequest</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Int</span><span class="o">],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">RuntimeContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">IndexRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">json</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">AnyRef</span><span class="o">]</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;@timestamp&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Timestamp</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="n">_1</span><span class="o">))</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="n">_2</span><span class="k">:</span> <span class="kt">java.lang.Integer</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">Requests</span><span class="o">.</span><span class="n">indexRequest</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="s">&quot;dummy3&quot;</span><span class="o">).</span><span class="n">`type`</span><span class="o">(</span><span class="s">&quot;my-type&quot;</span><span class="o">).</span><span class="n">source</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>まずは、260万件のログを送ってスナップショットのサイズを確認してみる. 送信したログのサイズ(100bytes×260万件)とほぼ同じ. そして、同じログを2回投入しても(distinct countなので
)サイズは増えない. 処理内部で集計した結果を保存している模様.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">$</span> <span class="n">cat</span> <span class="n">dummy_log</span><span class="o">.</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dummy_log2</span><span class="o">.</span><span class="n">log</span>
</span><span class='line'><span class="n">$</span> <span class="n">hadoop</span> <span class="n">fs</span> <span class="o">-</span><span class="n">du</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">flink</span><span class="o">/</span><span class="n">checkpoints</span><span class="o">/</span><span class="mi">9005988</span><span class="n">ca4dc6e871d50c2b310ed0a63</span>
</span><span class='line'><span class="mi">26000230</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">flink</span><span class="o">/</span><span class="n">checkpoints</span><span class="o">/</span><span class="mi">9005988</span><span class="n">ca4dc6e871d50c2b310ed0a63</span><span class="o">/</span><span class="n">chk</span><span class="o">-</span><span class="mi">183</span>
</span><span class='line'><span class="n">$</span> <span class="n">cat</span> <span class="n">dummy_log</span><span class="o">.</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dummy_log2</span><span class="o">.</span><span class="n">log</span>
</span><span class='line'><span class="n">$</span> <span class="n">hadoop</span> <span class="n">fs</span> <span class="o">-</span><span class="n">du</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">flink</span><span class="o">/</span><span class="n">checkpoints</span><span class="o">/</span><span class="mi">9005988</span><span class="n">ca4dc6e871d50c2b310ed0a63</span>
</span><span class='line'><span class="mi">26000230</span>  <span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">flink</span><span class="o">/</span><span class="n">checkpoints</span><span class="o">/</span><span class="mi">9005988</span><span class="n">ca4dc6e871d50c2b310ed0a63</span><span class="o">/</span><span class="n">chk</span><span class="o">-</span><span class="mi">196</span>
</span></code></pre></td></tr></table></div></figure>


<p>そして、その時のチェックポイント時間はJobManagerのログから確認できる. 大体6秒くらいかかる. TaskManagerのCPU使用率は定常的に高い.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">INFO</span>  <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">flink</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">checkpoint</span><span class="o">.</span><span class="nc">CheckpointCoordinator</span>     <span class="o">-</span> <span class="nc">Completed</span> <span class="n">checkpoint</span> <span class="mi">43</span> <span class="o">(</span><span class="n">in</span> <span class="mi">6291</span> <span class="n">ms</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>さらに、260万件を追加で投入するとチェックポイントに10秒〜数十秒かかるようになった. ジョブを実行しているTaskManagerは
CPU100%になり、スループットも大幅に落ちていた.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">INFO</span>  <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">flink</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">checkpoint</span><span class="o">.</span><span class="nc">CheckpointCoordinator</span>     <span class="o">-</span> <span class="nc">Completed</span> <span class="n">checkpoint</span> <span class="mi">145</span> <span class="o">(</span><span class="n">in</span> <span class="mi">41835</span> <span class="n">ms</span><span class="o">)</span>
</span><span class='line'><span class="nc">INFO</span>  <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">flink</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">checkpoint</span><span class="o">.</span><span class="nc">CheckpointCoordinator</span>     <span class="o">-</span> <span class="nc">Completed</span> <span class="n">checkpoint</span> <span class="mi">146</span> <span class="o">(</span><span class="n">in</span> <span class="mi">13530</span> <span class="n">ms</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://mail-archives.apache.org/mod_mbox/flink-user/201604.mbox/%3CCAMvK%3DYpTb6yZiv9ioL7%2Bmdn0W5Q3fRyNL210aGYcjzcbXQWxqg%40mail.gmail.com%3E">MLで聞いてみた</a> ところ、バックエンドでRocksDBを
試してみたら、とアドバイスをもらったのでやってみたが、変わらなかった. この処理の場合、状態を保存するストアには1レコードしか入らなくて、その値が非常に大きいので、効果が出なかった模様.</p>

<h2>思ったことなど</h2>

<ul>
<li>ユニークユーザ数等をカウントするようなケースだと、値の種類が数千万というのもあり得るので、上のような性能だと辛い. そして、このような処理の場合、最終的には一箇所にまとめて
数を数える感じになるので、分散スナップショットの恩恵も受けづらい.</li>
<li>現行のFlinkだと、スナップショットのたびに保持しているデータを全て書き出すので、incremental snapshotが導入されれば改善されるかも.</li>
<li>今の時点での対応としては、値のリストをFlinkに保持せずに外部のデータストア(Redisとか)に保持するというのが一つの解決策. その場合、デメリットとしてはスケールアウトが
制限されることと、障害時などにログがリプレイされることへの対応. ただ、後者については処理の性質上、何度同じデータを投入しても結果は変わらないので、問題にならない.</li>
<li>もしくは、HyperLogLogのような推定アルゴリズムを使って、精度と引き換えに状態のサイズを削減するか.</li>
</ul>


<p>試しにFlinkで受け取った値をRedisのSETに入れて同じ処理を実現してみたら、あっさり1000万件くらい処理できた. stateが小さい、または分散される場合はFlinkに任せて、
今回のような一部のケースでは外部のデータストアを使う、というのが現実的だろうか、と思っているところ.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/05/apache-flink-continuousprocessingtimetrigger/">Apache Flink ContinuousProcessingTimeTriggerの話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-05T11:33:23+09:00" pubdate data-updated="true">Apr 5<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/04/05/apache-flink-continuousprocessingtimetrigger/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/04/05/apache-flink-continuousprocessingtimetrigger/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(注: window周りのAPIを変えようという話(<a href="https://issues.apache.org/jira/browse/FLINK-3643">FLINK-3643</a>)があるので、以下で書かれている内容は近い将来obsoleteになる可能性があります)</p>

<p>自分のところでは、ストリーム処理のユースケースとして、ある程度長期間のwindowでデータを保持しながら、集計結果は短い間隔で出力したい、というのがある。</p>

<p>例えば、Norikra(Esper)のクエリだとこんな感じ。site_idごとに、過去3日間(72時間)のユニークユーザを集計し、結果は1分ごとに出力する、というもの。 集計対象のwindowは72時間のsliding time windowとなる。こういうwindowが長いケースは、Norikraだとプロセスを再起動したりした時にwindowの内容が全て失われるので辛い。Flinkでいい感じに実装したい。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="n">site_id</span><span class="p">,</span>
</span><span class='line'>    <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">userkey</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_uu</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">viewer_log</span><span class="p">.</span><span class="n">win</span><span class="p">:</span><span class="n">time</span><span class="p">(</span><span class="mi">3</span> <span class="k">day</span><span class="p">)</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>    <span class="n">site_id</span>
</span><span class='line'><span class="k">OUTPUT</span> <span class="k">LAST</span> <span class="k">EVERY</span> <span class="mi">1</span> <span class="k">min</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.0/apis/streaming/windows.html">ドキュメント</a>を読むと、以下のようにwindowの定義とは別にいつ計算処理がトリガされるか、いつwindowの中身が削除されるか、を好きに設定できるように見える。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">keyedStream</span>
</span><span class='line'>    <span class="o">.</span><span class="n">window</span><span class="o">(</span><span class="nc">SlidingEventTimeWindows</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">seconds</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="nc">Time</span><span class="o">.</span><span class="n">seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">trigger</span><span class="o">(</span><span class="nc">CountTrigger</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">evictor</span><span class="o">(</span><span class="nc">CountEvictor</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>なので、上記のようなものは以下の様なコードで実現できるかと思った。ContinuousProcessingTimeTriggerは、指定した間隔で集計を実行するが、その際にwindowの内容の削除は行わない、というもの。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">input</span> <span class="k">=</span> <span class="n">env</span><span class="o">.</span><span class="n">readFileStream</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span><span class="mi">100</span><span class="o">,</span><span class="nc">FileMonitoringFunction</span><span class="o">.</span><span class="nc">WatchType</span><span class="o">.</span><span class="nc">PROCESS_ONLY_APPENDED</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">lineToTuple</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">timeWindow</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">DAYS</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">trigger</span><span class="o">(</span><span class="nc">ContinuousProcessingTimeTrigger</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">seconds</span><span class="o">(</span><span class="mi">60</span><span class="o">)))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">fold</span><span class="o">((</span><span class="s">&quot;&quot;</span><span class="o">,</span><span class="k">new</span> <span class="n">scala</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">mutable</span><span class="o">.</span><span class="nc">HashSet</span><span class="o">[</span><span class="kt">String</span><span class="o">]())){(</span><span class="n">r</span><span class="o">,</span><span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="n">_2</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">_2</span><span class="o">)}}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">{</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="k">new</span> <span class="nc">Timestamp</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">()),</span> <span class="n">x</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">size</span><span class="o">)}</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">lineToTuple</span><span class="o">(</span><span class="n">line</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\W+&quot;</span><span class="o">)</span> <span class="n">filter</span> <span class="o">{</span><span class="k">_</span><span class="o">.</span><span class="n">nonEmpty</span><span class="o">}</span>
</span><span class='line'>    <span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span><span class="n">x</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>が、実際には期待どおりに動かないことが分かった。(MLで教えてもらった。<a href="http://mail-archives.apache.org/mod_mbox/flink-user/201603.mbox/%3CCAMvK=YpGWZZQQnPVknGYY07AhieHE+9ELkq0i6Q_72FCghsm-Q@mail.gmail.com%3E">ここ</a>とか<a href="http://mail-archives.apache.org/mod_mbox/flink-user/201603.mbox/%3CCAMvK%3DYo2NMk3Hxhie5Cr9coHS7qZ8ecaGOHHXg96mDB7H9_7Nw%40mail.gmail.com%3E">ここ</a>)</p>

<ul>
<li>トリガが発火しないケースがある</li>
<li>timeWindowが終了してもwindow内のデータが削除されない。結果、stateのサイズが増加する一方になる。(.trigger()を呼び出した時点で、元のtimeWindowのトリガは上書きされるらしい)</li>
</ul>


<p>って、これContinuousProcessingTimeTriggerは使えないのでは・・・。</p>

<p>結局、ContinuousProcessingTimeTriggerに修正を入れたカスタムTriggerを作成し、これを使用することで期待する動作をするようになった。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@PublicEvolving</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyContinuousProcessingTimeTrigger</span><span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">TimeWindow</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Trigger</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">W</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">interval</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ValueStateDescriptor</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">stateDesc</span> <span class="o">=</span>
</span><span class='line'>          <span class="k">new</span> <span class="n">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span><span class="s">&quot;fire-timestamp&quot;</span><span class="o">,</span> <span class="n">LongSerializer</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="nf">MyContinuousProcessingTimeTrigger</span><span class="o">(</span><span class="kt">long</span> <span class="n">interval</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TriggerResult</span> <span class="nf">onElement</span><span class="o">(</span><span class="n">Object</span> <span class="n">element</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">W</span> <span class="n">window</span><span class="o">,</span> <span class="n">TriggerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ValueState</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">fireState</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getPartitionedState</span><span class="o">(</span><span class="n">stateDesc</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">nextFireTimestamp</span> <span class="o">=</span> <span class="n">fireState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">nextFireTimestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">-</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">%</span> <span class="n">interval</span><span class="o">);</span>
</span><span class='line'>          <span class="n">fireState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">interval</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">ctx</span><span class="o">.</span><span class="na">registerProcessingTimeTimer</span><span class="o">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">interval</span><span class="o">));</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">&gt;=</span> <span class="n">nextFireTimestamp</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">-</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">%</span> <span class="n">interval</span><span class="o">);</span>
</span><span class='line'>          <span class="n">fireState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">interval</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">ctx</span><span class="o">.</span><span class="na">registerProcessingTimeTimer</span><span class="o">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">interval</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">FIRE</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TriggerResult</span> <span class="nf">onEventTime</span><span class="o">(</span><span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="n">W</span> <span class="n">window</span><span class="o">,</span> <span class="n">TriggerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">TriggerResult</span> <span class="nf">onProcessingTime</span><span class="o">(</span><span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="n">W</span> <span class="n">window</span><span class="o">,</span> <span class="n">TriggerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">ValueState</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">fireState</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getPartitionedState</span><span class="o">(</span><span class="n">stateDesc</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">nextFireTimestamp</span> <span class="o">=</span> <span class="n">fireState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// only fire if an element didn&#39;t already fire</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">&gt;=</span> <span class="n">nextFireTimestamp</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">-</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">%</span> <span class="n">interval</span><span class="o">);</span>
</span><span class='line'>                        <span class="n">fireState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">nextFireTimestamp</span> <span class="o">&gt;=</span> <span class="n">window</span><span class="o">.</span><span class="na">getEnd</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                           <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">FIRE_AND_PURGE</span><span class="o">;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">FIRE</span><span class="o">;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">TriggerResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">(</span><span class="n">W</span> <span class="n">window</span><span class="o">,</span> <span class="n">TriggerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@VisibleForTesting</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getInterval</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">interval</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;ContinuousProcessingTimeTrigger(&quot;</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * Creates a trigger that continuously fires based on the given interval.</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  * @param interval The time interval at which to fire.</span>
</span><span class='line'><span class="cm">  * @param &lt;W&gt; The type of {@link Window Windows} on which this trigger can operate.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">W</span> <span class="kd">extends</span> <span class="n">TimeWindow</span><span class="o">&gt;</span> <span class="n">MyContinuousProcessingTimeTrigger</span><span class="o">&lt;</span><span class="n">W</span><span class="o">&gt;</span> <span class="n">of</span><span class="o">(</span><span class="n">Time</span> <span class="n">interval</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">MyContinuousProcessingTimeTrigger</span><span class="o">&lt;&gt;(</span><span class="n">interval</span><span class="o">.</span><span class="na">toMilliseconds</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/05/apache-flink-performance/">Apache Flinkの性能 - デフォルトのJSONパーサが遅かった話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-05T10:50:12+09:00" pubdate data-updated="true">Apr 5<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/04/05/apache-flink-performance/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/04/05/apache-flink-performance/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>軽くApache Flinkの性能を測ってみた. 構成としては、Fluentd(in_tail→out_kafka_buffered)→Kafka→Flink→Elasticsearchで、仮想アクセスログ的なものに対して、URIごとの件数を1分ごとに集計して出力する、というもの。
メッセージフォーマットはJSON。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span>
</span><span class='line'><span class="n">env</span><span class="o">.</span><span class="n">enableCheckpointing</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'><span class="c1">// ....</span>
</span><span class='line'><span class="k">val</span> <span class="n">stream</span> <span class="k">=</span> <span class="n">env</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlinkKafkaConsumer09</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;kafka.dummy&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleStringSchema</span><span class="o">(),</span> <span class="n">properties</span><span class="o">))</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">json</span> <span class="k">=&gt;</span> <span class="nc">JSON</span><span class="o">.</span><span class="n">parseFull</span><span class="o">(</span><span class="n">json</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">AnyRef</span><span class="o">]]</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;uri&quot;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">y</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">y</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}}</span>
</span><span class='line'>  <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">timeWindow</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">MINUTES</span><span class="o">))</span>
</span><span class='line'>  <span class="o">.</span><span class="n">sum</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">(),</span> <span class="n">x</span><span class="o">)}</span>
</span><span class='line'>  <span class="o">.</span><span class="n">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">ElasticsearchSink</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">transports</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IndexRequestBuilder</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]]]</span>  <span class="o">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">createIndexRequest</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">RuntimeContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">IndexRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">json</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">AnyRef</span><span class="o">]</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;@timestamp&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Timestamp</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="n">_1</span><span class="o">))</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;uri&quot;</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">_2</span><span class="k">:</span> <span class="kt">java.lang.Integer</span><span class="o">)</span>
</span><span class='line'>      <span class="n">println</span><span class="o">(</span><span class="s">&quot;SENDING: &quot;</span> <span class="o">+</span> <span class="n">element</span><span class="o">)</span>
</span><span class='line'>      <span class="nc">Requests</span><span class="o">.</span><span class="n">indexRequest</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="s">&quot;dummy2&quot;</span><span class="o">).</span><span class="n">`type`</span><span class="o">(</span><span class="s">&quot;my-type&quot;</span><span class="o">).</span><span class="n">source</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>環境は以下の通り</p>

<ul>
<li>Kafka : 8vCPU, 8GBMemoryのVM*3, HDP2.4 (Kafka-0.9)

<ul>
<li>パーティション数は1なので、実質broker1台</li>
</ul>
</li>
<li>Flink : JobManager, TaskManagerともに8vCPU, 8GBMemoryのVM (Flink-1.0.0)

<ul>
<li>TaskManagerは3台だが、ジョブ並列度を1にしたので1台でしか動かない状態</li>
</ul>
</li>
<li>Elasticsearch: 4CPU, 4GB MemoryのVM*1 (Elasticsearch 1.7.2)</li>
</ul>


<p>URIは9種類なので、Elasticsearchには毎分9レコードが出力されることにいなる。 Elasticsearchに出力されたURIごとの件数を1分単位に合計したものを、Flinkのスループットと考える。 レコードの生成には <a href="https://github.com/sonots/dummer">dummer</a>を使用した。</p>

<p>で、普通にやったら2,000msg/secの入力を与えて、89,000msg/min = 1,483msg/secしか処理できなかった。FlinkプロセスのCPUが100%(1CPU使いきり)となり、Kafkaのlagが増えていく状態。
チェックポイント外したりESへの出力をやめたりしてみたのだけど、性能はさほど変わらず。</p>

<p>何にCPUを食っているんだろう？と思って、Flinkプロセスのjstackを何回か取ってみたら、こんな感じでJSONのパースを実行中であるケースが殆んどだった。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>    <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">parsing</span><span class="o">.</span><span class="n">combinator</span><span class="o">.</span><span class="nc">Parsers$$anon$2</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="nc">Parsers</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">881</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">parsing</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">JSON</span><span class="n">$</span><span class="o">.</span><span class="n">parseRaw</span><span class="o">(</span><span class="nc">JSON</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">51</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">parsing</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">JSON</span><span class="n">$</span><span class="o">.</span><span class="n">parseFull</span><span class="o">(</span><span class="nc">JSON</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">65</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="nc">KafkaTest3$$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="nc">KafkaTest3</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">46</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="nc">KafkaTest3$$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="nc">KafkaTest3</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">46</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">flink</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">scala</span><span class="o">.</span><span class="nc">DataStream$$anon$4</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">DataStream</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">485</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ということで、パーサをJacksonにしてみた。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">val</span> <span class="n">mapper</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="n">getExecutionEnvironment</span>
</span><span class='line'>    <span class="n">env</span><span class="o">.</span><span class="n">enableCheckpointing</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">stream</span> <span class="k">=</span> <span class="n">env</span>
</span><span class='line'>     <span class="o">.</span><span class="n">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlinkKafkaConsumer09</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;kafka.json&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleStringSchema</span><span class="o">(),</span> <span class="n">properties</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">parseJson</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">x</span><span class="k">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;uri&quot;</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="mi">1</span><span class="o">)}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">keyBy</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">timeWindow</span><span class="o">(</span><span class="nc">Time</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">MINUTES</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">sum</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">(),</span> <span class="n">x</span><span class="o">)}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">ElasticsearchSink</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">transports</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IndexRequestBuilder</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]]]</span>  <span class="o">{</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">def</span> <span class="n">createIndexRequest</span><span class="o">(</span><span class="n">element</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]],</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">RuntimeContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">IndexRequest</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">val</span> <span class="n">json</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">AnyRef</span><span class="o">]</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;@timestamp&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Timestamp</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="n">_1</span><span class="o">))</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;uri&quot;</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">_1</span><span class="o">)</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">_2</span><span class="k">:</span> <span class="kt">java.lang.Integer</span><span class="o">)</span>
</span><span class='line'>          <span class="nc">Requests</span><span class="o">.</span><span class="n">indexRequest</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="s">&quot;dummy2&quot;</span><span class="o">).</span><span class="n">`type`</span><span class="o">(</span><span class="s">&quot;my-type&quot;</span><span class="o">).</span><span class="n">source</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">env</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="s">&quot;KafkaTest9&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">parseJson</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">AnyRef</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mapper</span><span class="o">.</span><span class="n">readValue</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">AnyRef</span><span class="o">]])</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>そうしたら、スループットが大幅に向上して900,000msg/min=15,000msg/secを20%程度のCPU(1CPUの5分の1)で処理できた。</p>

<p><a href="http://www.slideshare.net/nestorhp/scala-json-features-and-performance">http://www.slideshare.net/nestorhp/scala-json-features-and-performance</a> にScalaで使えるJSONライブラリを比較したスライドがあるのだけど、
これを見るとScala標準のパーサと、その他のライブラリで速度が3桁くらい違う。えーーー、、、</p>

<p>ともあれ、十分に実用的な性能が出そうであることがわかったので良かった。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/25/gree-tech-talk-10/">GREE Tech Talk 10に行ってきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-03-25T21:12:46+09:00" pubdate data-updated="true">Mar 25<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/03/25/gree-tech-talk-10/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/03/25/gree-tech-talk-10/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://techtalk.labs.gree.jp/10/">GREE Tech Talk #10</a> に行ってきたのでメモ.</p>

<p>今回のテーマはData Visualizationということで、どんな見せ方をしたら効果的か、とかその辺の話が聞けたら良いな、と思って参加した.
実際にはそれよりも、こんなツールでこんなことできるよ、系の話が多かった. まあ、それはそれで面白かったのだけど、実際ツールは色々あるので、それらの中から適切なものを
選ぶためにも、みんな何をどう見て、どう活かしているのか、というあたりの話がもっとあると良かったなあ、というのが全体的な感想.</p>

<p>行って一番の収穫は、GREE反田さんのGrafanaにPrometheusのデータソースを追加した話だった. 自分も仕事でGrafana+Prometheusの組み合わせに出会って、
これはすごい、素晴らしいと思って最近使っているのだけど、Prometheusデータソースを作ったのが日本の方だとは知らなかった. 自分はまだProemtheusを十分に使いこなせて
いないので、懇親会の中で色々話を聞けたのは大変良かった。幾つかメモしておくと、</p>

<ul>
<li>Prometheusのアラートは任意のURLにJSONで投げることができるので、fluentdで受けて好きなところに飛ばす、ということができる</li>
<li>service discoveryにはファイルを使うことができる. つまり、例えばcronで社内の構成管理システムを叩いて、
ファイルに吐き出すようにしておけば、Prometheusがそれを随時読み込んでポーリング対象のリストを更新してくれる</li>
<li>Prometheusのクエリは結構色々できそう. 移動平均的な感じでトレンドを表示したり、変化が一定以上のものを表示したり.</li>
<li>GrafanaのTemplatingの機能も便利そう. 特定のホストグループに対してグラフを作ったり、というのが動的にできるっぽい</li>
<li>新しいメトリックを追加するのはちょっと面倒だなぁ、と思っているのだけど、そこはやはりexporterを書く感じになるらしい.</li>
</ul>


<p>Prometheusの話以外だと、<a href="http://e2d3.org/ja/">E2D3</a>というのも面白そうだった。Excelを使って、d3.js等を使った色々な可視化をすることができる.
可視化のパターンはテンプレートという形で誰でも作って公開できるので、既存のテンプレートを使って、そこにExcelから値を埋めて、、、という感じで
簡単に、見た目のインパクトがある素敵なグラフなどを作ることができるとのこと.
Excel、好きではないけどやっぱり手軽で素晴らしいツールなので、これとE2D3を使うと結構楽しそうだな、と思った.</p>

<p>自分はインフラとかミドルウェアが中心で、あまりUIを作る人では無いのだけど、処理した結果のデータから最終的な価値を引き出すところは可視化がやっぱり鍵で、
こんな風に見たいから、こんなデータを集めないと、とか、大量のデータを素早く処理したい、とか、もっとリアルタイムに、とか裏側のモチベーションに繋がる
ところがあると思う. いい感じの裏側作っても、見た目が無いと伝わらないし.</p>

<p>あと、会場では飲み物とお菓子が豊富でビックリした。無料で興味深い話を聞けた上に、懇親会まで含めて飲み食いも無料でできるとは、なんて素晴らしいんだと
思った勉強会でした. 関係者の皆さんに感謝です.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/26/trying-apache-flink/">Apache Flinkを試している</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-26T20:38:01+09:00" pubdate data-updated="true">Feb 26<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/02/26/trying-apache-flink/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/02/26/trying-apache-flink/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>耐障害性と拡張性のあるストリーム処理基盤が欲しい、と思って<a href="https://flink.apache.org/">Apache Flink</a>を調べている. 今はリアルタイム集計に<a href="http://norikra.github.io/">Norikra</a>を使っていて、これはとてもカジュアルに使えて良いのだけど、以下の様なケースだと難しい。</p>

<ul>
<li>比較的止めたくない処理で、サーバ障害時にも自動的に回復して欲しい</li>
<li>1日とか長いtime windowの集計をしているので、途中でサーバが落ちて集計中の状態が失われると辛い</li>
<li>トラフィックが増えてきて、複数サーバに負荷を分散したい</li>
<li>例えばストリームに含まれているIDに対応する値を外部のテーブルから取ってくるような、ちょっと複雑な処理をしたい</li>
</ul>


<h3>Flinkとはどのようなソフトウェアか</h3>

<p>一言で言うと、対障害性と拡張性を備えた、分散ストリーム処理基盤。バッチ処理もストリーム処理の仕組みでできるよね、ということでバッチ用、ストリーム用両方のAPIが提供されている。実行環境としては、Hadoop等と同じようにワーカプロセスが複数のサーバで立ち上がっていて、そこに対してジョブを投げるような感じになっている。バッチではジョブを投げるとデータを処理して終了、だけど、ストリーム処理では投げたジョブはずっと生きていて、ストリームにデータが流れてくるたびにそのデータを処理して出力する、という形になる。ジョブは、JavaとScalaで書くことができる。ロードマップにはSQL的なものもあるっぽいけど、今は存在しない。</p>

<h3>SparkとかStormと何が違うの？</h3>

<p>ググると色々出てくるが、<a href="https://yahooeng.tumblr.com/post/135321837876/benchmarking-streaming-computation-engines-at">米Yahooのベンチマーク</a>とか、<a href="http://www.altaterra.net/blogpost/288668/225612/Which-Stream-Processing-Engine-Storm-Spark-Samza-or-Flink">このページ</a>が分かりやすかった。</p>

<p>Stromとの比較で言うと、処理形態はほぼ同じ。ただ、大きな違いとしてStormでは各処理オペレータはstatelessになっていて、落ちると状態が失われる。永続化したかったら、自分で外部ストレージを使うようなコードを書く必要がある。耐障害性ということろだと、各レコードに対して処理が完了した際にackを返す仕組みがあるので、障害などでackが無かったら再度処理する、というような処理を書く感じになる。なので、例えば処理が途中まで行われて障害になると、そのレコードは重複して処理される形になる。Flinkは<a href="https://ci.apache.org/projects/flink/flink-docs-master/internals/stream_checkpointing.html">ここ</a>に詳しく書いてあるけど、オペレータがstatefulになっていて、チェックポイントごとに状態が保存される。障害時には、チェックポイントから復旧し、それ以降のレコードをリプレイすることで、exactly-onceを実現している。</p>

<p>あとは、Stormだと各処理オペレータ(Bolt)をJavaのクラスとして書かないといけないけど、Flinkは<code>stream.keyBy(...).map{...}.timeWindow(...)</code>みたいな感じのハイレベルのAPIが提供されている。</p>

<p>Spark Streamingとの違いで言うと、Spark Streamingは正確にはストリーミングではなくてマイクロバッチなので、そのバッチの間隔にストリーム処理のwindowが左右される。sliding time windowとか、一定数のレコードを保持するようなwindowは作ることができない。(ちゃんとドキュメント読んでないけど、そのはず)</p>

<h3>触ってみた</h3>

<p>とりあえず触ってみるには、<a href="https://ci.apache.org/projects/flink/flink-docs-release-0.10/quickstart/setup_quickstart.html">https://ci.apache.org/projects/flink/flink-docs-release-0.10/quickstart/setup_quickstart.html</a> に従えば良い。</p>

<p>ざっくりした流れとしては、</p>

<ul>
<li>バイナリをダウンロードして展開</li>
<li><code>./bin/start-local.sh</code> 実行</li>
<li><a href="http://localhost:8081/">http://localhost:8081/</a> でJobManagerを開く</li>
<li>exampleがバイナリと一緒に配布されているので、それを実行</li>
</ul>


<p>という感じで試すことができる。</p>

<p>クラスタを組むのも割と簡単で、 <a href="https://ci.apache.org/projects/flink/flink-docs-release-0.10/setup/cluster_setup.html">https://ci.apache.org/projects/flink/flink-docs-release-0.10/setup/cluster_setup.html</a> に従えばできる。</p>

<p>JobManagerというのがマスタで、TaskManagerというのがワーカになっているので、これをサーバに分散配置することになる。</p>

<p>流れとしては、</p>

<ul>
<li>各サーバにflink用のユーザとssh keyを用意

<ul>
<li>ssh keyは、起動スクリプトの中でssh経由でTaskManagerを起動するので必要.自分で各サーバのTaskManagerを起動して回るなら無くても良い</li>
</ul>
</li>
<li>各サーバにバイナリを配布</li>
<li>設定ファイル(flink-conf.yaml, slaves)を用意

<ul>
<li>flink-conf.yamlは、配布されているものをそのまま使って、JobManagerのアドレスを設定すれば良い</li>
<li>slavesはTaskManagerホストを列挙したもの。クラスタ起動スクリプトの中で使われる</li>
</ul>
</li>
</ul>


<p>となる。
  ジョブを書くには、<a href="https://ci.apache.org/projects/flink/flink-docs-release-0.10/quickstart/scala_api_quickstart.html">https://ci.apache.org/projects/flink/flink-docs-release-0.10/quickstart/scala_api_quickstart.html</a> に従う。mavenのアーキタイプが用意されてるので、それでプロジェクトのテンプレートを作って、ドキュメントの中にあるWordCountをコピーして走らせれば良い。</p>

<h3>感想</h3>

<p>試しにfluend→Kafka→Flink→Elasticsearch、とつなげて分散実行してみたり、プロセスを落としてみたりしたが、期待通りに動作した。例えば、5分間のtime windowで件数を集計するような処理を作って、実行中にプロセスを落とすと、障害が検知されてジョブが再実行される。そして、勝手に必要なリカバリがされるので、障害があっても無くても実行結果は変わらない。すごい。(もう少しちゃんと見ると、ずれるケースもありそうだけど、まだ詳しく見ていない)</p>

<p>並列度は、ジョブの投入時に指定できるので、ちゃんとKafkaのパーティションを複数作って並列度を指定して実行すれば、各TaskManagerに分散して実行される。</p>

<p>ただ、性能のところが今一つで、処理を3サーバに分散、5,000msg/secを投入してやってみたら、各サーバ1CPUを100%使って、Kafkaにメッセージが滞留する状態になった。実際に処理できたのは4,300msg/secくらい。3CPUで4,300msg/secだと大分コストが高いなあ、という印象。まあ、とりあえず動かしてみただけなので、何か正しくない可能性はある。もう少し試してみたい。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/08/hadoop-slash-spark-conference-2016/">Hadoop / Spark Conference Japan 2016 に行ってきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-08T19:55:02+09:00" pubdate data-updated="true">Feb 8<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/02/08/hadoop-slash-spark-conference-2016/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2016/02/08/hadoop-slash-spark-conference-2016/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>行ってきた。本当はストリーム処理をする上でのSparkってどうよ、的なあたりを聞きたかったのだけど、気がついたらHadoop周りの話題を多く聞いていたように思う。後で資料が公開されたら、行くことができなかったセッションの内容も見ておきたい。</p>

<p>以下、思ったことなどをつらつらと書いてみる。</p>

<p>ひとつ目は、これからはCPUをどうするかというのが大きい課題なのかなぁ、ということ。Sparkの、Project Tungstenの話の中でも出てきたけど、ハードウェアの進化という面だと、ディスクはSSDが普及してきたし、ネットワークは10Gbpsになってきたし、メモリは安価・大容量になったけど、CPUは劇的に速くなっていない。分散処理とか、GPUを使うとか、CPUの集積度を上げる、とかしていっても、最後には消費電力という課題が残る。数年前まではディスクI/Oがボトルネックで、これをどうするか、的な感じだったけど、その辺がある程度解決してきたのと、機械学習周りの普及で、今はCPUをいかに効率よく回すか、ということが重要になってきているのだなぁ、というのを感じた。</p>

<p>Sparkについては、懇親会の中で少し聞いたところだと、他の人が踏み固めた道を歩く分には割と大丈夫、という感じらしい。一般的なユースケースと違う使い方をしたり、リソース的にシビアだったりすると辛いのかな、と。これはSparkに限らない気はするけど。挙動が分かりやすいとか、今どうなっているのかが把握しやすいとか、再起動のしやすさとかの、運用の容易さは重要だよな、と思ったけど、そこは実際に動かしてみないとわからなそうだな。使っている人たちにもう少し詳しく聞けばよかった、というのは反省。</p>

<p>Hadoopは、まあ成熟している印象。使っていて大変だった系の話としては、Yahooさんの数百ノードまでスケールさせた時にHive MetastoreとかYARN Resource Managerに負荷が集中し話とか、Softbankさんの、オンプレでサーバの物理的な構築とか、故障対応のオペレーションの話があった。自分のところでも使っているけど、そこそこ余裕のある構成で組んで、普通に集計で使用している分には問題ないなあ、と思う。構築・運用周りも前は自分でがんばってたけど、Ambariを使い始めてから大分楽になった。もちろん、Hadoop自体が停滞しているわけではなくてYARNもHDFSもHiveも改善されて性能が上がったり、使いやすくなったりはしているわけで、それは使っている身としてはとてもありがたい。</p>

<p>あと、本題とは関係ないけど、懇親会の中で同僚と話していて、日頃仕事でやっていることとか、公開できる範囲でブログに書いて世の中に共有することは大事だよね、という話になった。自分もそういう記事に多分にお世話になっているので。ということで、まずは忘れないうちにこの記事を書いておこう、と思った次第です。(誰かの役は立たなそうだけど、まずは書く、ということで)</p>

<p>最後に、運営に関わられた方々、発表者の方々、どうもありがとうございました。各発表も、運営周りも、ランチも懇親会も素晴らしかったです。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/13/esper-and-java-method/">EsperのEPLでjava methodとGROUP Byを使ったらレコードが重複した話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-13T10:19:29+09:00" pubdate data-updated="true">Aug 13<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/08/13/esper-and-java-method/#disqus_thread"
             data-disqus-identifier="http://ogibayashi.github.io/blog/2015/08/13/esper-and-java-method/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Norikraで以下の様な感じの、GROUP BYして、SELECTの中でjavaメソッドを使うようなクエリを登録していたのだけど、なんか生成されるイベントが多い、というのが発端で調べてみた.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT str, str.split(",") as splitted, count(*) as cnt FROM str_stream.win:time_batch(10 sec) GROUP BY str</span></code></pre></td></tr></table></div></figure>


<p>上記のクエリを登録した状態で、以下のようにイベントを投入する.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo '{"str":"a,b,c"}' | norikra-client event send str_stream
</span><span class='line'>$ echo '{"str":"a,b,c"}' | norikra-client event send str_stream
</span><span class='line'>$ echo '{"str":"a,b,c"}' | norikra-client event send str_stream</span></code></pre></td></tr></table></div></figure>


<p>と、こんな感じで同じようなレコードが重複して生成される. <code>count(*)</code>は正しくカウントされているのだが、GROUP BYしているので1レコードになってて欲しい.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ norikra-client event sweep
</span><span class='line'>{"time":"2015/07/31 12:06:52","query":"splittest","str":"a,b,c","splitted":["a","b","c"],"cnt":3}
</span><span class='line'>{"time":"2015/07/31 12:06:52","query":"splittest","str":"a,b,c","splitted":["a","b","c"],"cnt":3}
</span><span class='line'>{"time":"2015/07/31 12:06:52","query":"splittest","str":"a,b,c","splitted":["a","b","c"],"cnt":3}</span></code></pre></td></tr></table></div></figure>


<p>Norikraではなく、Esperで同じことを実験してみても発生するので、Esperの事象っぽい.<a href="http://www.espertech.com/esper/release-5.2.0/esper-reference/html/processingmodel.html">公式ドキュメント</a>の&#8221;3.7.2. Output for Aggregation and Group-By&#8221;を見ると、以下の様な記述がある。 GROUP BYの中に無いフィールドをSELECTすると、入力イベントと同じ数の出力イベントが発生するよ、という話.</p>

<blockquote><p>If your statement selects non-aggregated properties and aggregation values, and groups only some properties using the group by clause, your statement may look as below:</p>

<p> select account, accountName, sum(amount)
from Withdrawal.win:time_batch(1 sec)
group by account</p>

<p>At the end of a time interval, the engine posts to listeners one row per event. The aggregation result aggregates per unique account.</p></blockquote>

<p>とは言え、GROUP BYの中に<code>str.split(",")</code>を入れても同じ. 値は同じでも、Stringクラスのオブジェクトは別になってしまうからなのかなぁ. 一応、回避策としてはfirsteverという、イベントの中で最初の値だけを取る関数があるので、<code>firstever(str.split(","))</code>のようにすると1レコードに集約できた.</p>

<p>Issueで聞いてみた.
<a href="https://github.com/espertechinc/esper/issues/18">https://github.com/espertechinc/esper/issues/18</a></p>

<p>若干うまく伝わらなかった気がするけど、javaメソッドではなく同等の機能を持つUDFを作ればうまくいくよ、ということらしい。実際、EsperのUDFを作ってみたら、ちゃんと集約された。</p>

<p>ちなみに、EsperのUDFを作るのは簡単で、以下のようにstaticなメソッドを持つクラスを作って</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUtilityClass</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">split</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">,</span> <span class="n">String</span> <span class="n">regex</span><span class="o">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">str</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ConfigurationクラスのaddPlugInSingleRowFunctionメソッドで、function名、クラス名、メソッド名を渡してやれば良い。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">addPlugInSingleRowFunction</span><span class="o">(</span><span class="s">&quot;split&quot;</span><span class="o">,</span> <span class="n">MyUtilityClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;split&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>まあ、都度UDF作るのも面倒なので、firsteverで回避出来る場合はそうするかなぁ.</p>

<p>そんな話でした.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/10/27/hadoop-summit-tokyo-2016/">Hadoop Summit 2016 Tokyo に行ったメモ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/21/about-my-flink-deployment/">現在稼働しているFlinkクラスタについて</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/13/thoughts-on-apache-flink/">Apache Flinkを試してみての感想</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/08/flink-state-management/">Apache Flinkのstate管理について</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/05/apache-flink-continuousprocessingtimetrigger/">Apache Flink ContinuousProcessingTimeTriggerの話</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/docker'>Docker (1)</a></li><li><a href='/blog/categories/elasticsearch'>elasticsearch (1)</a></li><li><a href='/blog/categories/esper'>Esper (1)</a></li><li><a href='/blog/categories/flink'>Flink (6)</a></li><li><a href='/blog/categories/fluentd'>fluentd (4)</a></li><li><a href='/blog/categories/hadoop'>Hadoop (4)</a></li><li><a href='/blog/categories/norikra'>Norikra (1)</a></li><li><a href='/blog/categories/openshift'>openshift (1)</a></li><li><a href='/blog/categories/puppet'>puppet (1)</a></li><li><a href='/blog/categories/spark'>Spark (1)</a></li><li><a href='/blog/categories/streaming'>Streaming (1)</a></li><li><a href='/blog/categories/mian-qiang-hui'>勉強会 (1)</a></li></ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - OGIBAYASHI Hironori -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'technotes-ogibayashi';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
